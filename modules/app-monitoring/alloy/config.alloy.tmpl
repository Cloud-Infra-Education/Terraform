// ======================================================
// Grafana Alloy pipeline (Seoul)
// - Logs   : Kubernetes pod logs -> Loki
// - Metrics: Simple scrape of services -> AMP (remote_write via SigV4 proxy)
// - Traces : OTLP receiver -> Tempo
//
// NOTE
// 1) This is a starter config.
// 2) Keep it minimal first; add filters/relabel later.
// ======================================================

logging {
  level  = "info"
  format = "logfmt"
}

// ----------------------
// Logs -> Loki
// ----------------------

discovery.kubernetes "pods" {
  role = "pod"
}

loki.source.kubernetes "pod_logs" {
  targets    = discovery.kubernetes.pods.targets
  forward_to = [loki.write.loki.receiver]
}

loki.write "loki" {
  endpoint {
    url = "${loki_push_url}"

    // Multi-tenancy header for Loki (auth_enabled=true)
    headers = {
      "X-Scope-OrgID" = "${tenant_id}",
    }
  }
}

// ----------------------
// Metrics -> AMP
// ----------------------

discovery.kubernetes "services" {
  role = "service"
}

prometheus.scrape "services" {
  targets    = discovery.kubernetes.services.targets
  forward_to = [prometheus.remote_write.amp.receiver]
}

prometheus.remote_write "amp" {
  endpoint {
    url = "${amp_remote_write_url}"
  }
}

// ----------------------
// Traces -> Tempo
// ----------------------

otelcol.receiver.otlp "default" {
  grpc {
    endpoint = "0.0.0.0:4317"
  }

  http {
    endpoint = "0.0.0.0:4318"
  }

  output {
    traces = [otelcol.exporter.otlp.tempo.input]
  }
}

otelcol.exporter.otlp "tempo" {
  client {
    endpoint = "${tempo_otlp_grpc_endpoint}"

    // Multi-tenancy header for Tempo
    headers = {
      "X-Scope-OrgID" = "${tenant_id}",
    }

    tls {
      insecure = true
    }
  }
}

