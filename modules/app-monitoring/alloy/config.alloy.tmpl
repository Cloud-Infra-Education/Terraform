// ======================================================
// Grafana Alloy pipeline (Seoul)
// - Logs  : Kubernetes pod logs -> Loki
// - Metrics: Simple scrape of annotated services -> Mimir (remote_write)
// - Traces : OTLP receiver -> Tempo
//
// NOTE
// 1) This is a starter config.
// 2) In real setups, add relabel/filters to limit scrape volume.
// ======================================================

logging {
  level  = "info"
  format = "logfmt"
}

// ----------------------
// Logs -> Loki
// ----------------------

discovery.kubernetes "pods" {
  role = "pod"
}

loki.source.kubernetes "pod_logs" {
  targets    = discovery.kubernetes.pods.targets
  forward_to = [loki.write.loki.receiver]
}

loki.write "loki" {
  endpoint {
    url = "${loki_push_url}"
  }
}

// ----------------------
// Metrics -> Mimir
// ----------------------

discovery.kubernetes "services" {
  role = "service"
}

// Scrape only if the Service has annotation prometheus.io/scrape="true".
prometheus.relabel "service_filter" {
  targets = discovery.kubernetes.services.targets

  rule {
    source_labels = ["__meta_kubernetes_service_annotation_prometheus_io_scrape"]
    regex         = "true"
    action        = "keep"
  }

  forward_to = [prometheus.scrape.services.receiver]
}

prometheus.scrape "services" {
  targets    = prometheus.relabel.service_filter.output
  forward_to = [prometheus.remote_write.mimir.receiver]
}

prometheus.remote_write "mimir" {
  endpoint {
    url = "${mimir_remote_write_url}"
  }
}

// ----------------------
// Traces -> Tempo
// ----------------------

otelcol.receiver.otlp "default" {
  grpc {
    endpoint = "0.0.0.0:4317"
  }

  http {
    endpoint = "0.0.0.0:4318"
  }

  output {
    traces = [otelcol.exporter.otlp.tempo.input]
  }
}

otelcol.exporter.otlp "tempo" {
  client {
    endpoint = "${tempo_otlp_grpc_endpoint}"

    tls {
      insecure = true
    }
  }
}

